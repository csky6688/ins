<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cableInspection.dao.StaffLocationDao">
<select id="queryStaff" parameterType="map" resultType="map">
	SELECT
	UPLOAD_STAFF,STAFF_NAME,DEPT_NAME,LONGITUDE,LATITUDE,AREA_ID,SON_AREA_ID
	FROM(
	SELECT
	UP.UPLOAD_STAFF,S.STAFF_NAME,UP.LONGITUDE,UP.LATITUDE,S.AREA_ID,S.SON_AREA_ID,D.DEPT_NAME,
	ROW_NUMBER() OVER (PARTITION BY UP.UPLOAD_STAFF ORDER BY UP.UPLOAD_TIME
	DESC) SEQ
	FROM TB_INS_UPLOAD_POINT UP
	LEFT JOIN TB_BASE_STAFF S ON S.STAFF_ID=UP.UPLOAD_STAFF
	LEFT JOIN TB_INS_STAFF_DEPT SD ON SD.STAFF_ID=UP.UPLOAD_STAFF
	LEFT JOIN TB_INS_DEPT D ON D.DEPT_ID=SD.DEPT_ID
	<![CDATA[
	WHERE UP.UPLOAD_TIME>=SYSDATE-1/48)
	]]>
	WHERE SEQ=1 AND AREA_ID=#{area_id}
</select>
<select id="queryEqp" parameterType="map" resultType="map" statementType="STATEMENT">
	SELECT * FROM (
	SELECT
	P.POINT_NO,P.POINT_NAME,P.LONGITUDE,P.LATITUDE,ET.EQUIPMENT_TYPE_NAME
	EQP_TYPE,
	DECODE(SIGN(${distance}-SDO_GEOM.SDO_DISTANCE(MDSYS.SDO_GEOMETRY(2001,8307,MDSYS.SDO_POINT_TYPE(P.LONGITUDE,P.LATITUDE,0),NULL,NULL),
	MDSYS.SDO_GEOMETRY(2001,8307,MDSYS.SDO_POINT_TYPE(${longitude},${latitude},0),NULL,NULL),1)),-1,0,1) distance
	FROM TB_INS_POINT P
	LEFT JOIN TB_INS_EQUIPMENT_TYPE ET ON ET.EQUIPMENT_TYPE_ID=P.EQP_TYPE_ID
	WHERE p.area_id=${area_id} and p.point_type=4
	) WHERE DISTANCE=1
</select>
</mapper>
